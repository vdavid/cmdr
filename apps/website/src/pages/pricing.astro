---
import Layout from '../layouts/Layout.astro'
import Header from '../components/Header.astro'
import Footer from '../components/Footer.astro'
import { version, dmgUrl } from '../lib/release'

// Paddle config - passed to client-side script
const paddleConfig = {
    clientToken: import.meta.env.PUBLIC_PADDLE_CLIENT_TOKEN ?? '',
    environment: (import.meta.env.PUBLIC_PADDLE_ENVIRONMENT ?? 'sandbox') as 'sandbox' | 'live',
    priceIds: {
        supporter: import.meta.env.PUBLIC_PADDLE_PRICE_ID_SUPPORTER ?? '',
        commercialSubscription: import.meta.env.PUBLIC_PADDLE_PRICE_ID_COMMERCIAL_SUBSCRIPTION ?? '',
        commercialPerpetual: import.meta.env.PUBLIC_PADDLE_PRICE_ID_COMMERCIAL_PERPETUAL ?? '',
    },
}
const isPaddleConfigured = paddleConfig.clientToken !== ''
---

<Layout title="Pricing — Cmdr" description="Cmdr is free forever for personal use. Commercial licenses from $59/year.">
    <Header />
    <main class="mx-auto max-w-5xl px-6 pt-32 pb-24">
        <!-- Hero -->
        <header class="mb-16 text-center">
            <h1 class="mb-4 text-4xl font-bold tracking-tight text-[var(--color-text-primary)] md:text-5xl">
                Free forever for personal use
            </h1>
            <p class="text-lg text-[var(--color-text-secondary)]">
                Use Cmdr at home without paying a cent. Using it at work? We'd appreciate your support.
            </p>
        </header>

        <!-- Download Button -->
        <div class="mb-16 text-center">
            <a
                href={dmgUrl}
                class="inline-flex items-center gap-3 rounded-lg bg-[var(--color-accent)] px-8 py-4 text-[var(--color-background)] transition-all duration-200 hover:bg-[var(--color-accent-hover)] hover:shadow-[var(--color-accent-glow)]"
            >
                <svg class="h-7 w-7" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path
                        d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"
                    ></path>
                </svg>
                <div class="flex flex-col">
                    <span class="text-lg font-medium leading-tight">Download Cmdr</span>
                    <span class="text-sm opacity-80">{version}</span>
                </div>
            </a>
            <p class="mt-3 text-sm text-[var(--color-text-tertiary)]">macOS only • Source-available (BSL 1.1)</p>
        </div>

        <!-- Pricing Cards -->
        <div class="mb-16 grid gap-6 md:grid-cols-2 lg:grid-cols-4">
            <!-- Personal (Free) -->
            <div class="rounded-2xl border border-[var(--color-border)] bg-[var(--color-surface)] p-6">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-[var(--color-text-primary)]">Personal</h3>
                    <p class="text-sm text-[var(--color-text-tertiary)]">For hobbyists and side projects</p>
                </div>
                <div class="mb-6">
                    <span class="text-3xl font-bold text-[var(--color-text-primary)]">Free</span>
                    <span class="text-[var(--color-text-tertiary)]"> forever</span>
                </div>
                <ul class="mb-6 space-y-2 text-sm text-[var(--color-text-secondary)]">
                    <li class="flex items-start gap-2">
                        <span class="text-[var(--color-accent)]">✓</span>
                        All features
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-[var(--color-accent)]">✓</span>
                        Unlimited machines
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-[var(--color-accent)]">✓</span>
                        Automatic updates
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-[var(--color-text-tertiary)]">✗</span>
                        <span class="text-[var(--color-text-tertiary)]">Commercial use</span>
                    </li>
                </ul>
                <div class="text-center text-sm text-[var(--color-text-tertiary)]">Just download and use it</div>
            </div>

            <!-- Supporter -->
            <div class="rounded-2xl border border-[var(--color-border)] bg-[var(--color-surface)] p-6">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-[var(--color-text-primary)]">Supporter</h3>
                    <p class="text-sm text-[var(--color-text-tertiary)]">Show some love ❤️</p>
                </div>
                <div class="mb-6">
                    <span class="text-3xl font-bold text-[var(--color-text-primary)]">$10</span>
                    <span class="text-[var(--color-text-tertiary)]"> one-time</span>
                </div>
                <ul class="mb-6 space-y-2 text-sm text-[var(--color-text-secondary)]">
                    <li class="flex items-start gap-2">
                        <span class="text-[var(--color-accent)]">✓</span>
                        Everything in Personal
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-[var(--color-accent)]">✓</span>
                        "Supporter" badge in app
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-[var(--color-accent)]">✓</span>
                        Warm fuzzy feeling
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-[var(--color-text-tertiary)]">✗</span>
                        <span class="text-[var(--color-text-tertiary)]">Commercial use</span>
                    </li>
                </ul>
                <button
                    type="button"
                    data-paddle-price="supporter"
                    disabled={!isPaddleConfigured}
                    class="block w-full cursor-pointer rounded-lg border border-[var(--color-border)] py-2 text-center text-sm font-medium text-[var(--color-text-primary)] transition-colors hover:bg-[var(--color-surface-hover)] disabled:cursor-not-allowed disabled:opacity-50"
                >
                    Buy supporter pack
                </button>
            </div>

            <!-- Commercial Subscription -->
            <div
                class="relative rounded-2xl border-2 border-[var(--color-accent)] bg-[var(--color-surface)] p-6 shadow-lg"
            >
                <div
                    class="absolute -top-3 left-1/2 -translate-x-1/2 rounded-full bg-[var(--color-accent)] px-3 py-1 text-xs font-medium text-[var(--color-background)]"
                >
                    Most popular
                </div>
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-[var(--color-text-primary)]">Commercial</h3>
                    <p class="text-sm text-[var(--color-text-tertiary)]">For work use</p>
                </div>
                <div class="mb-6">
                    <span class="text-lg text-[var(--color-text-tertiary)] line-through">$79</span>
                    <span class="text-3xl font-bold text-[var(--color-text-primary)]"> $59</span>
                    <span class="text-[var(--color-text-tertiary)]">/year</span>
                    <div class="mt-1 text-xs text-[var(--color-accent)]">First 1,000 licenses</div>
                </div>
                <ul class="mb-6 space-y-2 text-sm text-[var(--color-text-secondary)]">
                    <li class="flex items-start gap-2">
                        <span class="text-[var(--color-accent)]">✓</span>
                        All features
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-[var(--color-accent)]">✓</span>
                        <strong class="text-[var(--color-text-primary)]">Commercial use</strong>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-[var(--color-accent)]">✓</span>
                        Per user, unlimited machines
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-[var(--color-accent)]">✓</span>
                        Auto-renews annually
                    </li>
                </ul>
                <button
                    type="button"
                    data-paddle-price="commercialSubscription"
                    disabled={!isPaddleConfigured}
                    class="block w-full cursor-pointer rounded-lg bg-[var(--color-accent)] py-2 text-center text-sm font-medium text-[var(--color-background)] transition-all duration-200 hover:bg-[var(--color-accent-hover)] disabled:cursor-not-allowed disabled:opacity-50"
                >
                    Buy commercial license
                </button>
            </div>

            <!-- Commercial Perpetual -->
            <div class="rounded-2xl border border-[var(--color-border)] bg-[var(--color-surface)] p-6">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-[var(--color-text-primary)]">Perpetual</h3>
                    <p class="text-sm text-[var(--color-text-tertiary)]">Buy once, use forever</p>
                </div>
                <div class="mb-6">
                    <span class="text-3xl font-bold text-[var(--color-text-primary)]">$199</span>
                    <span class="text-[var(--color-text-tertiary)]"> one-time</span>
                </div>
                <ul class="mb-6 space-y-2 text-sm text-[var(--color-text-secondary)]">
                    <li class="flex items-start gap-2">
                        <span class="text-[var(--color-accent)]">✓</span>
                        All features
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-[var(--color-accent)]">✓</span>
                        <strong class="text-[var(--color-text-primary)]">Commercial use</strong>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-[var(--color-accent)]">✓</span>
                        Per user, unlimited machines
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-[var(--color-accent)]">✓</span>
                        3 years of updates
                    </li>
                </ul>
                <button
                    type="button"
                    data-paddle-price="commercialPerpetual"
                    disabled={!isPaddleConfigured}
                    class="block w-full cursor-pointer rounded-lg border border-[var(--color-border)] py-2 text-center text-sm font-medium text-[var(--color-text-primary)] transition-colors hover:bg-[var(--color-surface-hover)] disabled:cursor-not-allowed disabled:opacity-50"
                >
                    Buy perpetual license
                </button>
            </div>
        </div>

        <!-- FAQ Section -->
        <section>
            <h2 class="mb-8 text-center text-2xl font-bold text-[var(--color-text-primary)]">
                Frequently asked questions
            </h2>

            <div class="grid gap-6 md:grid-cols-2">
                <div class="rounded-lg border border-[var(--color-border-subtle)] bg-[var(--color-surface)] p-5">
                    <h3 class="mb-2 font-semibold text-[var(--color-text-primary)]">
                        What counts as "commercial use"?
                    </h3>
                    <p class="text-[var(--color-text-secondary)]">
                        If you're using Cmdr as part of your job (employment, freelancing, consulting), that's
                        commercial use. Side projects, open source work, and personal file management are all fine
                        without a commercial license.
                    </p>
                </div>

                <div class="rounded-lg border border-[var(--color-border-subtle)] bg-[var(--color-surface)] p-5">
                    <h3 class="mb-2 font-semibold text-[var(--color-text-primary)]">
                        Can I use it on multiple machines?
                    </h3>
                    <p class="text-[var(--color-text-secondary)]">
                        Yes! Use Cmdr on as many machines as you like — laptop, desktop, remote debugging rig, whatever.
                        Just make sure you're the one using your license.
                    </p>
                </div>

                <div class="rounded-lg border border-[var(--color-border-subtle)] bg-[var(--color-surface)] p-5">
                    <h3 class="mb-2 font-semibold text-[var(--color-text-primary)]">
                        What's the difference between subscription and perpetual?
                    </h3>
                    <p class="text-[var(--color-text-secondary)]">
                        Subscription ($59/year) auto-renews annually and always includes the latest updates. Perpetual
                        ($199) is a one-time purchase that includes 3 years of updates — after that, you can keep using
                        your current version forever or renew updates at a reduced rate.
                    </p>
                </div>

                <div class="rounded-lg border border-[var(--color-border-subtle)] bg-[var(--color-surface)] p-5">
                    <h3 class="mb-2 font-semibold text-[var(--color-text-primary)]">Can I see the source code?</h3>
                    <p class="text-[var(--color-text-secondary)]">
                        Yes! Cmdr is <a
                            href="https://github.com/vdavid/cmdr"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-[var(--color-accent)] underline underline-offset-2 hover:text-[var(--color-accent-hover)]"
                            >source-available on GitHub</a
                        >. You can view, learn from, and modify the code. The license (BSL 1.1) converts to AGPL-3.0
                        after 3 years.
                    </p>
                </div>

                <div class="rounded-lg border border-[var(--color-border-subtle)] bg-[var(--color-surface)] p-5">
                    <h3 class="mb-2 font-semibold text-[var(--color-text-primary)]">What if I regret the purchase?</h3>
                    <p class="text-[var(--color-text-secondary)]">
                        We offer a <a
                            href="/refund"
                            class="text-[var(--color-accent)] underline underline-offset-2 hover:text-[var(--color-accent-hover)]"
                            >30-day, no-questions-asked refund</a
                        >. Just email us and we'll sort it out.
                    </p>
                </div>

                <div class="rounded-lg border border-[var(--color-border-subtle)] bg-[var(--color-surface)] p-5">
                    <h3 class="mb-2 font-semibold text-[var(--color-text-primary)]">Do you offer team licenses?</h3>
                    <p class="text-[var(--color-text-secondary)]">
                        Each person needs their own license. For teams of 5+, email us at <a
                            href="mailto:legal@getcmdr.com"
                            class="text-[var(--color-accent)] underline underline-offset-2 hover:text-[var(--color-accent-hover)]"
                            >legal@getcmdr.com</a
                        > for volume pricing.
                    </p>
                </div>
            </div>
        </section>
    </main>
    <Footer />

    {/* Organization name modal for commercial licenses */}
    <div id="org-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="mx-4 w-full max-w-md rounded-2xl border border-[var(--color-border)] bg-[var(--color-surface)] p-6 shadow-xl">
            <h3 class="mb-2 text-xl font-semibold text-[var(--color-text-primary)]">Organization details</h3>
            <p class="mb-6 text-sm text-[var(--color-text-secondary)]">
                Enter your company or organization name. This will appear on your invoice.
                Paddle will collect your billing address and tax ID during checkout.
            </p>
            <form id="org-form">
                <label class="mb-4 block">
                    <span class="mb-1 block text-sm font-medium text-[var(--color-text-primary)]">Organization name <span class="text-[var(--color-accent)]">*</span></span>
                    <input
                        type="text"
                        id="org-name-input"
                        required
                        placeholder="Acme Corporation"
                        class="w-full rounded-lg border border-[var(--color-border)] bg-[var(--color-background)] px-4 py-3 text-[var(--color-text-primary)] placeholder-[var(--color-text-tertiary)] focus:border-[var(--color-accent)] focus:outline-none focus:ring-2 focus:ring-[var(--color-accent)]/20"
                    />
                </label>
                <div class="flex gap-3">
                    <button
                        type="button"
                        id="org-cancel-btn"
                        class="flex-1 rounded-lg border border-[var(--color-border)] py-2.5 text-sm font-medium text-[var(--color-text-primary)] transition-colors hover:bg-[var(--color-surface-hover)]"
                    >
                        Cancel
                    </button>
                    <button
                        type="submit"
                        class="flex-1 rounded-lg bg-[var(--color-accent)] py-2.5 text-sm font-medium text-[var(--color-background)] transition-all hover:bg-[var(--color-accent-hover)]"
                    >
                        Continue to checkout
                    </button>
                </div>
            </form>
        </div>
    </div>

    {/* Paddle checkout integration - config passed via data attribute */}
    {
        isPaddleConfigured && (
            <div id="paddle-config" data-config={JSON.stringify(paddleConfig)} class="hidden" />
        )
    }
    {isPaddleConfigured && <script src="https://cdn.paddle.com/paddle/v2/paddle.js" is:inline />}
    {
        isPaddleConfigured && (
            <script is:inline>
                ;(function () {
                    const configEl = document.getElementById('paddle-config')
                    if (!configEl) return
                    const paddleConfig = JSON.parse(configEl.dataset.config)

                    // Initialize Paddle
                    if (paddleConfig.environment === 'sandbox') {
                        Paddle.Environment.set('sandbox')
                    }
                    Paddle.Initialize({ token: paddleConfig.clientToken })

                    // Modal elements
                    const modal = document.getElementById('org-modal')
                    const form = document.getElementById('org-form')
                    const input = document.getElementById('org-name-input')
                    const cancelBtn = document.getElementById('org-cancel-btn')

                    // Track which price we're buying
                    let pendingPriceId = null

                    // Commercial license types that require org name
                    const commercialPriceKeys = ['commercialSubscription', 'commercialPerpetual']

                    function openModal(priceId) {
                        pendingPriceId = priceId
                        input.value = ''
                        modal.classList.remove('hidden')
                        modal.classList.add('flex')
                        input.focus()
                    }

                    function closeModal() {
                        modal.classList.add('hidden')
                        modal.classList.remove('flex')
                        pendingPriceId = null
                    }

                    // Handle buy button clicks
                    document.querySelectorAll('[data-paddle-price]').forEach(function (button) {
                        button.addEventListener('click', function () {
                            const priceKey = button.dataset.paddlePrice
                            const priceId = paddleConfig.priceIds[priceKey]
                            if (!priceId) return

                            if (commercialPriceKeys.includes(priceKey)) {
                                openModal(priceId)
                            } else {
                                Paddle.Checkout.open({ items: [{ priceId: priceId }] })
                            }
                        })
                    })

                    // Handle form submission
                    form.addEventListener('submit', function (e) {
                        e.preventDefault()
                        const orgName = input.value.trim()
                        if (!orgName || !pendingPriceId) return

                        closeModal()

                        // Open Paddle checkout with organization info
                        Paddle.Checkout.open({
                            items: [{ priceId: pendingPriceId }],
                            customData: { organization_name: orgName },
                            customer: { business: { name: orgName } },
                        })
                    })

                    // Close modal handlers
                    cancelBtn.addEventListener('click', closeModal)
                    modal.addEventListener('click', function (e) {
                        if (e.target === modal) closeModal()
                    })
                    document.addEventListener('keydown', function (e) {
                        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                            closeModal()
                        }
                    })
                })()
            </script>
        )
    }
</Layout>
