---
import Layout from '../../layouts/Layout.astro'
import Header from '../../components/Header.astro'
import Footer from '../../components/Footer.astro'
import BlogImageClick from '../../components/BlogImageClick.astro'
import { getCollection, render } from 'astro:content'
import { marked } from 'marked'

const moreMarker = '<!-- more -->'
const posts = (await getCollection('blog')).sort((a, b) => b.data.date.getTime() - a.data.date.getTime())

const postsWithExcerpts = await Promise.all(
    posts.map(async (post) => {
        const moreIndex = post.body?.indexOf(moreMarker) ?? -1
        const hasExcerpt = moreIndex > -1
        const excerptHtml = hasExcerpt ? await marked.parse(post.body!.slice(0, moreIndex)) : null

        const formattedDate = post.data.date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
        })

        return { post, hasExcerpt, excerptHtml, formattedDate }
    }),
)
---

<Layout title="Blog â€” Cmdr" description="Product updates, behind-the-scenes stories, and tips from the Cmdr team.">
    <Header />
    <main class="mx-auto max-w-3xl px-6 pt-32 pb-24">
        <h1 class="mb-12 text-4xl font-bold tracking-tight text-[var(--color-text-primary)]">Blog</h1>

        {
            postsWithExcerpts.map(async ({ post, hasExcerpt, excerptHtml, formattedDate }) => {
                return (
                    <article class="mb-16">
                        <header class="mb-6">
                            <time
                                class="text-sm text-[var(--color-text-tertiary)]"
                                datetime={post.data.date.toISOString().slice(0, 10)}
                            >
                                {formattedDate}
                            </time>
                            <h2 class="mt-1 text-2xl font-bold tracking-tight">
                                <a
                                    href={`/blog/${post.id}`}
                                    class="text-[var(--color-text-primary)] no-underline transition-colors hover:text-[var(--color-accent)]"
                                >
                                    {post.data.title}
                                </a>
                            </h2>
                        </header>
                        {hasExcerpt ? (
                            <div class="blog-content">
                                <Fragment set:html={excerptHtml} />
                                <a href={`/blog/${post.id}`} class="read-more-link">
                                    Read more &rarr;
                                </a>
                            </div>
                        ) : (
                            async () => {
                                const { Content } = await render(post)
                                return (
                                    <div class="blog-content">
                                        <Content />
                                    </div>
                                )
                            }
                        )}
                    </article>
                )
            })
        }
    </main>
    <Footer />
</Layout>

<BlogImageClick />

<style>
    @import '../../styles/blog-prose.css';

    .read-more-link {
        display: inline-block;
        margin-top: 0.5rem;
        color: var(--color-accent);
        font-weight: 500;
        text-decoration: none;
        transition: text-decoration 0.2s;
    }

    .read-more-link:hover {
        text-decoration: underline;
        text-underline-offset: 2px;
    }
</style>
