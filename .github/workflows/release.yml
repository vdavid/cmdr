name: Release

on:
    push:
        tags:
            - 'v*'

permissions:
    contents: write

jobs:
    release:
        name: Build and release
        runs-on: macos-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

            - name: Install mise
              uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2

            - name: Install tools with mise
              run: mise install

            - name: Install frontend dependencies
              run: pnpm install --frozen-lockfile
              working-directory: ./apps/desktop

            - name: Generate SvelteKit types
              run: pnpm exec svelte-kit sync
              working-directory: ./apps/desktop

            - name: Install x86_64 target for universal binary
              run: rustup target add x86_64-apple-darwin

            - name: Build and release
              uses: tauri-apps/tauri-action@73fb865345c54760d875b94642314f8c0c894afa # v0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
                  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
              with:
                  projectPath: ./apps/desktop
                  tagName: ${{ github.ref_name }}
                  releaseName: 'Cmdr ${{ github.ref_name }}'
                  releaseBody: 'See CHANGELOG.md for details.'
                  releaseDraft: false
                  prerelease: false
                  args: --target universal-apple-darwin

            - name: Extract changelog for this version
              id: changelog
              run: |
                  VERSION="${{ github.ref_name }}"
                  VERSION="${VERSION#v}"  # Remove 'v' prefix

                  # Extract section for this version from CHANGELOG.md
                  NOTES=$(sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '1d;$d')

                  # Write to file to preserve newlines
                  echo "$NOTES" > /tmp/notes.txt

            - name: Get artifact paths and signatures
              id: artifacts
              run: |
                  # Debug: list all bundle files
                  echo "=== Bundle directory contents ==="
                  find apps/desktop/src-tauri/target/universal-apple-darwin/release/bundle -type f | head -20

                  # Find the .app.tar.gz and its signature
                  BUNDLE=$(find apps/desktop/src-tauri/target/universal-apple-darwin/release/bundle -name "*.app.tar.gz" | head -1)
                  SIG_FILE="${BUNDLE}.sig"

                  echo "Bundle: $BUNDLE"
                  echo "Sig file: $SIG_FILE"

                  if [ ! -f "$SIG_FILE" ]; then
                      echo "ERROR: Signature file not found!"
                      exit 1
                  fi

                  SIGNATURE=$(cat "$SIG_FILE")
                  FILENAME=$(basename "$BUNDLE")

                  echo "signature=$SIGNATURE" >> $GITHUB_OUTPUT
                  echo "filename=$FILENAME" >> $GITHUB_OUTPUT

            - name: Generate latest.json
              run: |
                  VERSION="${{ github.ref_name }}"
                  VERSION="${VERSION#v}"

                  # Read notes from file, escape for JSON
                  NOTES=$(cat /tmp/notes.txt | jq -Rs .)

                  # Write to /tmp first (will copy to main branch later)
                  # All platforms point to the same universal binary
                  cat > /tmp/latest.json << EOF
                  {
                      "version": "$VERSION",
                      "notes": $NOTES,
                      "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
                      "platforms": {
                          "darwin-universal": {
                              "signature": "${{ steps.artifacts.outputs.signature }}",
                              "url": "https://github.com/vdavid/cmdr/releases/download/${{ github.ref_name }}/${{ steps.artifacts.outputs.filename }}"
                          },
                          "darwin-aarch64": {
                              "signature": "${{ steps.artifacts.outputs.signature }}",
                              "url": "https://github.com/vdavid/cmdr/releases/download/${{ github.ref_name }}/${{ steps.artifacts.outputs.filename }}"
                          },
                          "darwin-x86_64": {
                              "signature": "${{ steps.artifacts.outputs.signature }}",
                              "url": "https://github.com/vdavid/cmdr/releases/download/${{ github.ref_name }}/${{ steps.artifacts.outputs.filename }}"
                          }
                      }
                  }
                  EOF

            - name: Commit latest.json to main
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  # Fetch and checkout main branch
                  git fetch origin main
                  git checkout main

                  # Copy the generated file and commit
                  cp /tmp/latest.json apps/website/public/latest.json
                  git add apps/website/public/latest.json
                  git commit -m "chore(release): update latest.json for ${{ github.ref_name }} [skip ci]"
                  git push origin main

            - name: Trigger website deploy
              run: |
                  # Compute HMAC-SHA256 signature
                  PAYLOAD='{}'
                  SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "${{ secrets.DEPLOY_WEBHOOK_SECRET }}" | cut -d' ' -f2)

                  # Send signed request to webhook
                  curl -f -X POST https://getcmdr.com/hooks/deploy-website \
                      -H "Content-Type: application/json" \
                      -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
                      -d "$PAYLOAD"
