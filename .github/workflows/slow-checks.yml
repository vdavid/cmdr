name: Slow checks

# Daily security and dependency checks
# Runs at 4 AM CET (3 AM UTC) to catch newly disclosed vulnerabilities
# GitHub automatically emails repo admins on failure
on:
    schedule:
        - cron: '0 3 * * *' # 4 AM CET = 3 AM UTC
    workflow_dispatch: # Allow manual trigger

jobs:
    dependency-checks:
        name: Dependency checks
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

            - name: Install mise
              uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2

            - name: Install tools with mise
              run: mise install

            - name: Cache Cargo
              uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
              with:
                  path: ~/.cargo/registry/cache
                  key: ${{ runner.os }}-cargo-${{ hashFiles('apps/desktop/src-tauri/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-cargo-

            - name: Install Tauri dependencies (Linux)
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libacl1-dev

            - name: Build check tool
              run: go build -o check .
              working-directory: ./scripts/check

            - name: Run cargo-audit
              run: ./scripts/check/check --check desktop-rust-cargo-audit --ci

            - name: Run cargo-deny
              run: ./scripts/check/check --check desktop-rust-cargo-deny --ci

            - name: Install nightly toolchain (for cargo-udeps)
              run: rustup toolchain install nightly

            - name: Run cargo-udeps
              run: ./scripts/check/check --check desktop-rust-cargo-udeps --ci
